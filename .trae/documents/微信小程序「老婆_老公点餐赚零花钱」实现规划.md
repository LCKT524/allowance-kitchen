## 仓库与工程结构
- GitHub 创建 Monorepo：`allowance-kitchen`
- 目录：
  - `apps/miniprogram`：微信小程序源码（页面、组件、网络层）
  - `apps/api`：Vercel Serverless（TypeScript，REST 路由）
  - `supabase/sql`：表结构与 RLS/触发器 SQL
  - `packages/shared`：类型与常量（状态枚举、DTO）
- CI/CD：GitHub→Vercel 自动部署；保护分支与 PR 流程

## 环境与密钥
- Vercel 环境变量：`WECHAT_APPID`、`WECHAT_SECRET`、`SUPABASE_URL`、`SUPABASE_SERVICE_ROLE_KEY`、`DEEPSEEK_API_KEY`
- 小程序：配置 `request 合法域名` 指向 Vercel 域名；不暴露任何服务端密钥

## 数据库与安全
- 表：`users`、`menus`、`orders`、`order_items`、`messages`
- RLS：基于 `users.openid` 与订单参与者限制访问；菜单只读，写入受控
- 价格规则：
  - 服务端强制：`unit_price` 按 `menus.category` 写入（荤=3.00，素=1.50）
  - `total_price` 聚合计算；客户端不可传单价
  - 后续加数据库触发器与约束

## 业务流程与 API
- 鉴权
  - `POST /api/auth/wechat-login`：`wx.login`→`code`→换取 `openid`→签发自定义 JWT
- 菜单
  - `GET /api/menu/list`、`GET /api/menu/detail`
  - `POST /api/menu/create`（受控，AI/运营）
- 下单与接单
  - `POST /api/order/create`（菜单+数量→固定价）
  - `POST /api/order/accept`（角色接单→状态流转）
  - `GET /api/order/detail`（含项与参与者）
- 聊天
  - `GET /api/order/messages`（分页）
  - `POST /api/order/messages/send`
  - 首版安全轮询（后续可升级 WebSocket/Supabase Realtime）
- AI 点餐（DeepSeek）
  - `POST /api/ai/suggest-and-create`：根据对话生成菜名/用材/做法/分类→入库→返回推荐项
  - OpenAI 兼容 REST 调用（按官方 DeepSeek 文档设置 baseURL/模型名）

## 小程序前端
- 页面：`home`（登录/角色选择）、`menu`（列表/详情/分类）、`order`（购物车与下单）、`orders`（订单列表）、`order-detail`（详情+聊天）、`ai-order`（AI 对话）
- 组件：菜品卡片、购物车、消息气泡与输入框、状态标签、角色切换
- 网络层：统一请求封装（token 注入、错误处理、重试与限流）

## 验收用例
- 固定单价正确、越权访问拒绝、订单状态机边界（pending→accepted→in_progress→completed/cancelled）
- AI 生成质量与分类一致性、消息读写与分页可靠性

## 里程碑与交付
- M1：仓库初始化与脚手架；CI/CD 打通
- M2：微信登录与用户映射（openid→JWT）；`users` 表与 RLS
- M3：菜单模块（列表/详情/新增），固定价格规则落地
- M4：订单流（下单/接单/状态机），聊天室（轮询）
- M5：DeepSeek 点餐（对话→推荐→入库），质量与防护
- M6：测试、监控与发布（真机联调、灰度、日志）

## 下一步
- 初始化 GitHub 仓库与 Monorepo 结构
- 创建 Vercel 项目并配置环境变量（使用你提供的 DeepSeek 密钥作为服务端 ENV）
- 建表与 RLS 初版 SQL；实现 `auth`、`menu`、`order` 基础 API；搭建小程序页面骨架